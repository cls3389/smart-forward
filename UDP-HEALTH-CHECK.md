# UDP健康检查说明

## UDP健康检查的现实挑战

### 问题背景
UDP是无连接协议，不像TCP可以建立连接验证服务可用性：
- **TCP**: 可以connect()验证端口是否开放
- **UDP**: 发送数据包不保证送达，无法确定服务状态

### 实际部署场景
在实际使用中，后端地址通常是：
- **直接IP**: `192.168.1.100:3389` (内网RDP)
- **主机名**: `server.local:7777` (局域网游戏)
- **改hosts**: 通过修改hosts文件映射域名到IP

**很少使用DNS劫持**，因为需要管理员权限且复杂度高。

### 智能检查策略

#### 1. TCP规则 (可靠验证)
```rust
// TCP可以建立连接验证
match TcpStream::connect("192.168.1.100:3389").await {
    Ok(_) => "服务可用", 
    Err(_) => "服务不可用",
}
```

#### 2. UDP规则 (智能处理)
```rust
if target.parse::<SocketAddr>().is_ok() {
    // IP:PORT格式 - 跳过检查
    // 原因：无法有效验证UDP服务状态
    Ok("假定可用")
} else {
    // 域名格式 - DNS解析检查
    match resolve_target("game.example.com:7777").await {
        Ok(_) => "DNS解析成功",
        Err(_) => "域名解析失败"
    }
}
```

### 为什么这样设计？

#### IP地址直接跳过的原因：
- ✅ IP地址本身已验证格式正确
- ✅ 避免发送无意义的UDP探测包
- ✅ 减少对目标服务的干扰
- ✅ 快速响应，不影响转发性能

#### 域名才进行DNS检查：
- ✅ 验证域名可以正确解析
- ✅ 确保网络连通性基本正常
- ✅ 避免向无效域名转发

### 典型使用场景

#### 1. 内网RDP (IP格式)
```yaml
- name: "RDP"
  targets: ["192.168.1.100:3389"]  # 直接IP，跳过UDP检查
```

#### 2. 游戏服务器 (域名格式)  
```yaml
- name: "Game"
  targets: ["game.company.com:7777"]  # 域名，进行DNS检查
```

#### 3. 修改hosts文件
```
# C:\Windows\System32\drivers\etc\hosts
192.168.1.100  game-server.local
```
```yaml
- name: "Game"
  targets: ["game-server.local:7777"]  # 本地域名，DNS检查
```

### 为什么不做深度UDP检查？

1. **协议未知**: 不知道UDP服务的具体协议格式
2. **可能干扰**: 随意发包可能触发防护机制
3. **性能考虑**: UDP检查本身就不可靠，不如快速跳过
4. **实用主义**: 大多数UDP服务配置正确后很少变化

## 总结

**UDP健康检查 = 智能判断 + 最小干预**

- **IP:PORT格式**: 跳过检查，直接转发
- **域名格式**: DNS解析验证
- **重点**: 不干扰服务，快速响应

这是在UDP协议限制和实际部署需求之间的最佳平衡方案。
