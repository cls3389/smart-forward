# æ™ºèƒ½ç½‘ç»œè½¬å‘å™¨ï¼ˆSmart Forwardï¼‰

ä¸€ä¸ªä¸“æ³¨ç¨³å®šä¸é«˜æ€§èƒ½çš„å¤šåè®®ç½‘ç»œè½¬å‘å™¨ï¼Œæ”¯æŒ TCP/UDP/HTTPï¼Œå…·å¤‡åŠ¨æ€åœ°å€è§£æã€å¥åº·æ£€æŸ¥ä¸æ™ºèƒ½æ•…éšœè½¬ç§»ã€‚é€‚åˆä¸ªäºº/å®¶åº­ç½‘ç»œæœåŠ¡ã€RDP/HTTPS/ç½‘ç›˜ç­‰åœºæ™¯ã€‚

## ğŸ“š é¡¹ç›®æ¦‚è¿°

### è®¾è®¡ç†å¿µ
æœ¬é¡¹ç›®ä¸“ä¸º**ä¸ªäººç½‘ç»œæœåŠ¡ä¼˜åŒ–**è®¾è®¡ï¼Œé€šè¿‡æ™ºèƒ½åœ°å€ç®¡ç†å’Œç«¯å£æ˜ å°„ï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š
- **å…ç«¯å£è®¿é—®**: é€šè¿‡åŸŸååŠ«æŒåˆ°æœ¬åœ°443ç«¯å£ï¼Œå®ç°æ— ç«¯å£å·è®¿é—®
- **å•ç«¯å£æ±‡èš**: TCP+UDPåŒç«¯å£ç›‘å¬ï¼Œæ”¯æŒSTUNç©¿é€å’ŒRDPç­‰åè®®
- **åŠ¨æ€åœ°å€ç®¡ç†**: åç«¯åœ°å€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œä¿æŒè¿æ¥ç¨³å®šæ€§
- **æ€§èƒ½ä¼˜åŒ–**: ç»•è¿‡ç³»ç»Ÿä»£ç†ï¼Œç›´æ¥è¿æ¥ï¼Œæå‡ç½‘ç»œæ€§èƒ½

### æ ¸å¿ƒåº”ç”¨åœºæ™¯
1. **åŸŸååŠ«æŒå…ç«¯å£è®¿é—®**: å°†åç«¯åŠ¨æ€åœ°å€æ˜ å°„åˆ°æœ¬åœ°443ç«¯å£ï¼Œé€šè¿‡åŸŸåç›´æ¥è®¿é—®
2. **HTTPè‡ªåŠ¨è·³è½¬HTTPS**: è‡ªåŠ¨å°†HTTPè¯·æ±‚é‡å®šå‘åˆ°HTTPSï¼Œç®€åŒ–è¿æ¥å¹¶æå‡å®‰å…¨æ€§
3. **STUNç©¿é€åŒç«¯å£è¿æ¥**: TCP+UDPåŒç«¯å£ç›‘å¬ï¼Œæ”¯æŒRDPç­‰éœ€è¦åŒåè®®çš„åº”ç”¨
   - RDPé€šè¿‡STUNåœ°å€è¿æ¥æ—¶ï¼Œç”±äºç©¿é€ç«¯å£ä¸å›ºå®šï¼Œéœ€è¦åŒæ—¶æ”¯æŒTCPå’ŒUDP
   - å•ç«¯å£æ±‡èšç®€åŒ–äº†NATç©¿é€é…ç½®ï¼Œæå‡è¿æ¥æˆåŠŸç‡
4. **å›ºå®šç«¯å£åŠ¨æ€åœ°å€**: æœ¬åœ°å›ºå®šç«¯å£è¿æ¥è¿œç¨‹å˜åŒ–çš„æœåŠ¡åœ°å€ï¼ˆå¦‚ç½‘ç›˜æœåŠ¡ï¼‰
5. **é«˜æ€§èƒ½ç½‘ç»œè¿æ¥**: ç»•è¿‡ç³»ç»Ÿä»£ç†ï¼Œç›´æ¥è¿æ¥ï¼Œæå‡ç½‘ç»œæ€§èƒ½å’Œå®‰å…¨æ€§

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **å¤šåè®®**: TCP / UDP / HTTPï¼ˆ80 è‡ªåŠ¨ 301 åˆ° HTTPSï¼‰
- **åŠ¨æ€åœ°å€**: æ”¯æŒ A/AAAA ä¸ TXT è®°å½•ï¼ˆ`hostname` -> TXT `IP:PORT`ï¼‰
- **å¥åº·æ£€æŸ¥**: TCPè¿æ¥æ£€æŸ¥ + UDP DNSè§£ææ£€æŸ¥ï¼Œè‡ªåŠ¨åˆ‡æ¢æœ€ä½³ç›®æ ‡
- **ä¼šè¯ç²˜æ€§**: ä¸¥æ ¼æŒ‰é…ç½®é¡ºåºé€‰æ‹©ï¼Œä¿æŒè¿æ¥ç¨³å®šæ€§
- **UDP ä¼šè¯æ˜ å°„**: å®¢æˆ·ç«¯ç‹¬ç«‹ä¸Šæ¸¸ socketï¼Œå·²å®ç°å›ç¨‹ä¸ 60 ç§’é—²ç½®æ¸…ç†
- **çµæ´»ç¼“å†²**: å…¨å±€ä¸è§„åˆ™çº§ `buffer_size`

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### é¡¹ç›®æœ¬è´¨
æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª**æ™ºèƒ½ç«¯å£æ˜ å°„å’Œåœ°å€ç®¡ç†å™¨**ï¼Œä¸“ä¸ºä¸ªäººç½‘ç»œæœåŠ¡ä¼˜åŒ–è®¾è®¡ã€‚æ ¸å¿ƒåŠŸèƒ½æ˜¯ï¼š
- **ç«¯å£æ˜ å°„**: å°†åç«¯åŠ¨æ€åœ°å€ç«¯å£æ˜ å°„åˆ°æœ¬åœ°å›ºå®šç«¯å£ï¼ˆå¦‚443ï¼‰
- **åè®®æ±‡èš**: TCP+UDPåŒç«¯å£ç›‘å¬ï¼Œæ”¯æŒSTUNç©¿é€å’ŒRDPç­‰åº”ç”¨
  - RDPå¯é€šè¿‡STUNåœ°å€è¿›è¡ŒTCP+UDPè¿æ¥ï¼ˆSTUNç©¿é€æ—¶ç«¯å£ä¸å›ºå®šï¼‰
  - å•ç«¯å£åŒæ—¶å¤„ç†TCPå’ŒUDPåè®®ï¼Œç®€åŒ–é˜²ç«å¢™é…ç½®
- **åŠ¨æ€åœ°å€ç®¡ç†**: åç«¯åœ°å€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œä¿æŒè¿æ¥ç¨³å®šæ€§
- **æ€§èƒ½ä¼˜åŒ–**: ç»•è¿‡ç³»ç»Ÿä»£ç†ï¼Œç›´æ¥è¿æ¥ï¼Œæå‡ç½‘ç»œæ€§èƒ½

### ä»£ç æ¶æ„ (æé™ç²¾ç®€ç‰ˆ)
```
src/
â”œâ”€â”€ main.rs      # ç¨‹åºå…¥å£ (170è¡Œ)
â”œâ”€â”€ config.rs    # é…ç½®ç®¡ç† (172è¡Œ)  
â”œâ”€â”€ common.rs    # æ ¸å¿ƒç®¡ç†å™¨ (501è¡Œ) - DNSè§£æ+å¥åº·æ£€æŸ¥+ç›®æ ‡é€‰æ‹©
â”œâ”€â”€ utils.rs     # å·¥å…·å‡½æ•° (211è¡Œ) - ç½‘ç»œå·¥å…·+ç»Ÿè®¡åŠŸèƒ½
â””â”€â”€ forwarder.rs # è½¬å‘å™¨å®ç° (683è¡Œ) - TCP/UDP/HTTP/ç»Ÿä¸€/æ™ºèƒ½è½¬å‘

æ€»è®¡: 5ä¸ªæ¨¡å—, ~1600è¡Œä»£ç 
ç‰¹ç‚¹: æ¨¡å—ç²¾ç®€, é€»è¾‘æ¸…æ™°, æ€§èƒ½ä¼˜åŒ–
```

### æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é…ç½®ç®¡ç†æ¨¡å—   â”‚    â”‚   è½¬å‘å™¨æ¨¡å—     â”‚    â”‚   å…¬å…±ç®¡ç†æ¨¡å—   â”‚
â”‚   (config.rs)   â”‚    â”‚ (forwarder.rs)  â”‚    â”‚ (common.rs)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   YAML é…ç½®     â”‚    â”‚   ç«¯å£æ˜ å°„      â”‚    â”‚   åŠ¨æ€åœ°å€      â”‚
â”‚   åŠ¨æ€æ›´æ–°      â”‚    â”‚   TCP+UDPæ±‡èš   â”‚    â”‚   å¥åº·æ£€æŸ¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç»“æ„
```
src/
â”œâ”€â”€ main.rs              # ç¨‹åºå…¥å£ï¼Œå‘½ä»¤è¡Œè§£æï¼Œæ—¥å¿—åˆå§‹åŒ–
â”œâ”€â”€ config.rs            # é…ç½®ç®¡ç†ï¼ŒYAMLè§£æï¼Œé…ç½®éªŒè¯
â”œâ”€â”€ common.rs            # å…¬å…±ç®¡ç†å™¨ï¼Œç»Ÿè®¡ä¿¡æ¯ï¼Œå¥åº·æ£€æŸ¥
â”œâ”€â”€ forwarder/           # è½¬å‘å™¨æ¨¡å—
â”‚   â”œâ”€â”€ mod.rs           # è½¬å‘å™¨ç»Ÿä¸€æ¥å£å’Œæ™ºèƒ½è½¬å‘å™¨
â”‚   â”œâ”€â”€ tcp.rs           # TCPåè®®è½¬å‘å™¨
â”‚   â”œâ”€â”€ udp.rs           # UDPåè®®è½¬å‘å™¨
â”‚   â”œâ”€â”€ http.rs          # HTTPåè®®è½¬å‘å™¨
â”‚   â””â”€â”€ unified.rs       # ç»Ÿä¸€è½¬å‘å™¨ï¼ˆå¤šåè®®æ”¯æŒï¼‰
â”œâ”€â”€ stats.rs             # ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å’Œç®¡ç†
â””â”€â”€ utils.rs             # å·¥å…·å‡½æ•°ï¼Œç½‘ç»œå·¥å…·ï¼Œæ—¶é—´å·¥å…·
```

## ğŸ› ï¸ æŠ€æœ¯é€‰å‹

### æ ¸å¿ƒè¯­è¨€ä¸è¿è¡Œæ—¶
- **Rust 2024 Edition**: é€‰æ‹© Rust ä½œä¸ºä¸»è¦å¼€å‘è¯­è¨€
  - é›¶æˆæœ¬æŠ½è±¡ï¼Œé«˜æ€§èƒ½
  - å†…å­˜å®‰å…¨ï¼Œæ— æ•°æ®ç«äº‰
  - å¹¶å‘å®‰å…¨ï¼Œé€‚åˆç½‘ç»œç¼–ç¨‹
  - è·¨å¹³å°ç¼–è¯‘æ”¯æŒ

### å¼‚æ­¥è¿è¡Œæ—¶
- **Tokio 1.0**: å¼‚æ­¥è¿è¡Œæ—¶æ¡†æ¶
  - `rt-multi-thread`: å¤šçº¿ç¨‹è¿è¡Œæ—¶
  - `net`: ç½‘ç»œ I/O æ”¯æŒ
  - `time`: æ—¶é—´ç›¸å…³åŠŸèƒ½
  - `macros`: å¼‚æ­¥å®æ”¯æŒ
  - `sync`: åŒæ­¥åŸè¯­
  - `signal`: ä¿¡å·å¤„ç†
  - `io-util`: I/O å·¥å…·å‡½æ•°

### åºåˆ—åŒ–ä¸é…ç½®
- **Serde 1.0**: åºåˆ—åŒ–/ååºåˆ—åŒ–æ¡†æ¶
  - æ”¯æŒ YAML é…ç½®æ–‡ä»¶
  - ç±»å‹å®‰å…¨çš„é…ç½®ç®¡ç†
- **Serde YAML 0.9**: YAML æ ¼å¼æ”¯æŒ
- **Serde JSON 1.0**: JSON æ ¼å¼æ”¯æŒï¼ˆæ—¥å¿—è¾“å‡ºï¼‰

### é”™è¯¯å¤„ç†
- **Anyhow 1.0**: é”™è¯¯å¤„ç†åº“
  - ç®€åŒ–çš„é”™è¯¯ä¼ æ’­
  - ç±»å‹æ“¦é™¤çš„é”™è¯¯ç±»å‹
- **Thiserror 1.0**: è‡ªå®šä¹‰é”™è¯¯ç±»å‹
  - ç¼–è¯‘æ—¶é”™è¯¯å®šä¹‰
  - è‡ªåŠ¨å®ç°æ ‡å‡† trait

### æ—¥å¿—ç³»ç»Ÿ
- **Log 0.4**: æ—¥å¿—é—¨é¢
- **Env_logger 0.10**: æ—¥å¿—å®ç°
  - æ”¯æŒç¯å¢ƒå˜é‡é…ç½®
  - çµæ´»çš„æ—¥å¿—æ ¼å¼

### å‘½ä»¤è¡Œè§£æ
- **Clap 4.0**: å‘½ä»¤è¡Œå‚æ•°è§£æ
  - æ´¾ç”Ÿå®æ”¯æŒ
  - è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯

### å¹¶å‘ä¸åŒæ­¥
- **Futures 0.3**: å¼‚æ­¥ç¼–ç¨‹åŸºç¡€
- **Async-trait 0.1**: å¼‚æ­¥ trait æ”¯æŒ
- **Dashmap 5.0**: å¹¶å‘ HashMap
  - é«˜æ€§èƒ½å¹¶å‘è®¿é—®
  - æ— é”æ•°æ®ç»“æ„

### æ—¶é—´å¤„ç†
- **Chrono 0.4**: æ—¶é—´æ—¥æœŸåº“
  - æ—¶åŒºæ”¯æŒ
  - åºåˆ—åŒ–é›†æˆ

### ç½‘ç»œä¸ DNS
- **Trust-dns-resolver 0.23**: DNS è§£æå™¨
  - ç³»ç»Ÿé…ç½®æ”¯æŒ
  - Tokio è¿è¡Œæ—¶é›†æˆ
- **Local-ip-address 0.6**: æœ¬åœ° IP åœ°å€è·å–

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

### 1. ç«¯å£æ˜ å°„æœºåˆ¶
- **æœ¬åœ°ç«¯å£ç»‘å®š**: å°†åç«¯åŠ¨æ€åœ°å€æ˜ å°„åˆ°æœ¬åœ°å›ºå®šç«¯å£ï¼ˆå¦‚443ï¼‰
- **åŸŸååŠ«æŒ**: é€šè¿‡æœ¬åœ°DNSåŠ«æŒï¼Œå®ç°å…ç«¯å£å·è®¿é—®
- **åŠ¨æ€æ›´æ–°**: åç«¯åœ°å€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æ˜ å°„å…³ç³»

### 2. åè®®æ±‡èšæ”¯æŒ
- **TCP+UDPåŒç«¯å£**: å•ä¸ªç«¯å£åŒæ—¶ç›‘å¬TCPå’ŒUDPåè®®
- **HTTPè‡ªåŠ¨è·³è½¬**: è‡ªåŠ¨å°†HTTPè¯·æ±‚é‡å®šå‘åˆ°HTTPSï¼Œç®€åŒ–è¿æ¥
- **STUNç©¿é€**: æ”¯æŒNATç©¿é€å’ŒSTUNåè®®
- **RDPä¼˜åŒ–**: é’ˆå¯¹RDPç­‰éœ€è¦åŒåè®®çš„åº”ç”¨è¿›è¡Œä¼˜åŒ–
  - RDPé€šè¿‡STUNåœ°å€è¿æ¥æ—¶ï¼Œç©¿é€ç«¯å£ä¸å›ºå®šï¼Œéœ€è¦åŠ¨æ€å¤„ç†TCP+UDP
  - è‡ªåŠ¨è¯†åˆ«åè®®ç±»å‹ï¼Œæ™ºèƒ½è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†é€»è¾‘
  - æ”¯æŒåŠ¨æ€ç«¯å£æ˜ å°„ï¼Œé€‚åº”STUNç©¿é€çš„ç«¯å£å˜åŒ–

### 3. æ€§èƒ½ä¼˜åŒ–è®¾è®¡
- **ç»•è¿‡ç³»ç»Ÿä»£ç†**: ç›´æ¥è¿æ¥ï¼Œé¿å…ä»£ç†å±‚æ€§èƒ½æŸè€—
- **è™šæ‹Ÿç»„ç½‘**: æœ¬åœ°ç½‘ç»œæ ˆä¼˜åŒ–ï¼Œæå‡è¿æ¥æ€§èƒ½
- **åŠ¨æ€åœ°å€ç¼“å­˜**: å‡å°‘DNSæŸ¥è¯¢ï¼Œæå‡å“åº”é€Ÿåº¦

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. ç­–ç•¥æ¨¡å¼
- ä¸åŒåè®®ä½¿ç”¨ä¸åŒçš„è½¬å‘ç­–ç•¥
- é€šè¿‡ trait å®ç°ç»Ÿä¸€çš„è½¬å‘æ¥å£
- æ”¯æŒè¿è¡Œæ—¶ç­–ç•¥åˆ‡æ¢

### 2. å·¥å‚æ¨¡å¼
- æ ¹æ®é…ç½®è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„è½¬å‘å™¨
- æ”¯æŒå¤šåè®®åŒæ—¶è½¬å‘
- åŠ¨æ€åŠ è½½å’Œå¸è½½è½¬å‘å™¨

### 3. è§‚å¯Ÿè€…æ¨¡å¼
- å¥åº·æ£€æŸ¥ç»“æœé€šçŸ¥
- ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é€šçŸ¥
- é…ç½®å˜æ›´é€šçŸ¥

### 4. çŠ¶æ€æ¨¡å¼
- è¿æ¥çŠ¶æ€ç®¡ç†
- æ•…éšœè½¬ç§»çŠ¶æ€æœº
- ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

## âš¡ æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. å¼‚æ­¥ I/O
- å…¨å¼‚æ­¥ç½‘ç»œ I/O æ“ä½œ
- éé˜»å¡ I/O æ¨¡å‹
- é«˜å¹¶å‘è¿æ¥å¤„ç†

### 2. å†…å­˜ç®¡ç†
- é›¶æ‹·è´æ•°æ®ä¼ è¾“
- æ™ºèƒ½ç¼“å†²åŒºç®¡ç†
- å†…å­˜æ± ä¼˜åŒ–

### 3. å¹¶å‘æ§åˆ¶
- æ— é”æ•°æ®ç»“æ„
- è¯»å†™é”åˆ†ç¦»
- åŸå­æ“ä½œä¼˜åŒ–

### 4. ç«¯å£æ˜ å°„ä¼˜åŒ–
- åŠ¨æ€åœ°å€è§£æå’Œç¼“å­˜
- æœ¬åœ°ç«¯å£åˆ°è¿œç¨‹åœ°å€çš„æ™ºèƒ½æ˜ å°„
- åè®®æ±‡èšå’ŒSTUNç©¿é€æ”¯æŒ

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. è¾“å…¥éªŒè¯
- é…ç½®å‚æ•°éªŒè¯
- ç½‘ç»œæ•°æ®éªŒè¯
- åè®®åˆè§„æ€§æ£€æŸ¥

### 2. é”™è¯¯å¤„ç†
- ä¼˜é›…çš„é”™è¯¯æ¢å¤
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å®‰å…¨çš„é”™è¯¯ä¼ æ’­

### 3. èµ„æºç®¡ç†
- è‡ªåŠ¨èµ„æºæ¸…ç†
- å†…å­˜æ³„æ¼é˜²æŠ¤
- è¿æ¥è¶…æ—¶ç®¡ç†

## ğŸ“Š æ ¸å¿ƒç®—æ³•è®¾è®¡

### 1. æ•…éšœè½¬ç§»ç®—æ³•

#### ä¼šè¯ç²˜æ€§ç­–ç•¥
```rust
// é…ç½®é¡ºåºä¼˜å…ˆ
for target in targets {
    if target.healthy {
        return target;
    }
}

// ä¿æŒå½“å‰è¿æ¥
if current_target.is_healthy() {
    return current_target;
}

// æ•…éšœè½¬ç§»é€»è¾‘ï¼šä¼˜å…ˆé€‰æ‹©å¥åº·çš„ç›®æ ‡
if let Some(healthy_target) = healthy_targets.first() {
    return healthy_target.resolved;
}
// å¦‚æœæ²¡æœ‰å¥åº·ç›®æ ‡ï¼Œé€‰æ‹©å¤±è´¥æ¬¡æ•°æœ€å°‘çš„ç›®æ ‡
return fallback_target.resolved;
```

#### æ•…éšœè½¬ç§»ç®—æ³•
- **å¥åº·æ£€æŸ¥**: TCPè¿æ¥æµ‹è¯•ï¼Œå¿«é€Ÿæ£€æµ‹æœåŠ¡å¯ç”¨æ€§
- **å¤±è´¥é˜ˆå€¼**: è¿ç»­å¤±è´¥2æ¬¡æ ‡è®°ä¸ºä¸å¥åº·
- **æ¢å¤æœºåˆ¶**: æˆåŠŸå“åº”åç«‹å³æ¢å¤å¥åº·çŠ¶æ€
- **ä¼˜å…ˆçº§ç­–ç•¥**: æŒ‰é…ç½®é¡ºåºé€‰æ‹©ï¼Œä¿æŒè¿æ¥ç¨³å®šæ€§

### 2. ç¼“å†²åŒºç®¡ç†

#### æ™ºèƒ½ç¼“å†²åŒºåˆ†é…
```rust
pub fn get_effective_buffer_size(&self, default_size: usize) -> usize {
    self.buffer_size
        .or(self.global_buffer_size)
        .unwrap_or(default_size)
}
```

#### ç¼“å†²åŒºä¼˜åŒ–ç­–ç•¥
- å…¨å±€é»˜è®¤ç¼“å†²åŒºå¤§å°
- è§„åˆ™çº§ç¼“å†²åŒºè¦†ç›–
- åè®®ç‰¹å®šç¼“å†²åŒºä¼˜åŒ–
- åŠ¨æ€ç¼“å†²åŒºè°ƒæ•´

### 3. è¿æ¥ç®¡ç†

#### TCP è¿æ¥å¤„ç†
```rust
// æ¯æ¬¡è¿æ¥éƒ½åˆ›å»ºæ–°çš„TCPè¿æ¥
let mut target_stream = connect_with_timeout_and_retry(
    target, 
    1,  // max_retries
    8,  // timeout_secs
    2,  // retry_delay_secs
    &format!("è§„åˆ™ {}", rule_name)
).await?;

// å¹¶å‘åŒå‘æ•°æ®è½¬å‘
let (client_to_target, target_to_client) = tokio::join!(
    Self::forward_data(&mut client_read, &mut target_write, &mut client_buffer, &stats, true),
    Self::forward_data(&mut target_read, &mut client_write, &mut target_buffer, &stats, false),
);
```

#### UDP ä¼šè¯æ˜ å°„
```rust
struct UDPSession {
    client_addr: SocketAddr,
    upstream_socket: UdpSocket,
    last_activity: Instant,
    data: Vec<u8>,
}
```

#### ä¼šè¯æ¸…ç†æœºåˆ¶
- TCP: è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨æ¸…ç†
- UDP: 60ç§’é—²ç½®è¶…æ—¶
- å®šæœŸæ¸…ç†ä»»åŠ¡
- å†…å­˜ä½¿ç”¨ç›‘æ§
- è¿æ¥æ•°é™åˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Rust 1.70+ 
- Cargo
- Windows/Linux/macOS

### å¿«é€Ÿç¼–è¯‘è¿è¡Œ
```bash
# ç¼–è¯‘ç”Ÿäº§ç‰ˆæœ¬
cargo build --release

# Windowsè¿è¡Œ
.\target\release\smart-forward.exe --config config.yaml

# Linuxè¿è¡Œ  
./target/release/smart-forward --config config.yaml

# éªŒè¯é…ç½®
./target/release/smart-forward --validate-config
```

Windows æ‰¹å¤„ç†è„šæœ¬ä¹Ÿå¯ç”¨ï¼š`run.bat` / `run-daemon.bat`ã€‚

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### è®¾è®¡ç›®æ ‡
- **é«˜å¹¶å‘**: æ”¯æŒæ•°åƒå¹¶å‘è¿æ¥
- **ä½å»¶è¿Ÿ**: æ¯«ç§’çº§å“åº”æ—¶é—´
- **é«˜åå**: æ”¯æŒ Gbps çº§æ•°æ®ä¼ è¾“
- **ç¨³å®šæ€§**: 7x24 å°æ—¶ç¨³å®šè¿è¡Œ

### ä¼˜åŒ–ç­–ç•¥
- å¼‚æ­¥ I/O æ¨¡å‹
- ç«¯å£æ˜ å°„å’Œåè®®æ±‡èš
- HTTPè‡ªåŠ¨è·³è½¬HTTPS
- åŠ¨æ€åœ°å€ç®¡ç†å’Œç¼“å­˜
- ç»•è¿‡ç³»ç»Ÿä»£ç†ç›´æ¥è¿æ¥
- æ— é”æ•°æ®ç»“æ„

## ğŸ”§ è¿è¡Œä¸æ—¥å¿—
- è‹¥æœªè®¾ç½® `RUST_LOG`ï¼Œè¯»å– `config.yaml` çš„ `logging.level`ï¼›æ ¼å¼æ”¯æŒ `json` / `text`
- ç¨‹åºè‡ªåŠ¨è®¾ç½®æ—¶åŒº `Asia/Shanghai`

## âš™ï¸ é…ç½®ç¤ºä¾‹ï¼ˆconfig.yamlï¼‰
```yaml
logging:
  level: "info"   # debug/info/warn/error
  format: "json"  # json/text

network:
  listen_addr: "0.0.0.0"

buffer_size: 8192  # å…¨å±€é»˜è®¤ç¼“å†²åŒº

rules:
  - name: "HTTPS"
    listen_port: 443
    protocol: "tcp"
    buffer_size: 4096
    targets:
      - "192.168.5.254:443"
      - "121.40.167.222:50443"
      - "stun-443.4.ipto.top"   # çº¯åŸŸåï¼ŒTXT è®°å½•è§£æ

  - name: "RDP"
    listen_port: 99
    # æœªæ˜¾å¼æŒ‡å®šæ—¶ï¼Œé»˜è®¤åŒæ—¶æ”¯æŒ tcp+udp
    buffer_size: 16384  # å»ºè®® 16K~32Kï¼›ä¸€èˆ¬çº¦30Mbps è¶³å¤Ÿ
    targets:
      - "192.168.5.12:3389"
      - "121.40.167.222:57111"
      - "ewin10.4.ipto.top"
      - "stun-rdp.example.com"  # STUNåœ°å€ï¼Œç©¿é€ç«¯å£ä¸å›ºå®šï¼Œè‡ªåŠ¨å¤„ç†TCP+UDP

# æç¤ºï¼šUDP ä¸è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œä»…è¿›è¡Œ UDP è½¬å‘ï¼›å¥åº·æ£€æŸ¥åªå¯¹ TCP ç”Ÿæ•ˆã€‚

  - name: "Drive"
    listen_port: 6690
    protocol: "tcp"
    buffer_size: 32768
    targets:
      - "192.168.5.3:6690"
      - "121.40.167.222:6690"
      - "drive.4.ipto.top"
```

### åè®®å­—æ®µ
- `protocol`: å•åè®®ï¼ˆ`tcp` | `udp` | `http`ï¼‰
- `protocols`: å¤šåè®®åˆ—è¡¨ï¼ˆå¦‚ `["tcp","udp"]`ï¼‰ï¼›è‹¥éƒ½æœªè®¾ç½®ï¼Œé»˜è®¤å¯ç”¨ `tcp+udp`
- **STUNåœ°å€æ”¯æŒ**: å½“ç›®æ ‡ä¸ºSTUNåœ°å€æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨TCP+UDPåŒåè®®æ”¯æŒï¼Œé€‚åº”ç©¿é€ç«¯å£ä¸å›ºå®šçš„ç‰¹æ€§

### åŠ¨æ€æ›´æ–°ï¼ˆä¸å®ç°ä¸€è‡´ï¼‰
- `check_interval`ï¼ˆé»˜è®¤ 15sï¼‰
- `connection_timeout`ï¼ˆé»˜è®¤ 300sï¼‰
- `auto_reconnect`ï¼ˆé»˜è®¤ trueï¼‰

## ğŸ”® æœªæ¥è§„åˆ’

### 1. åŠŸèƒ½æ‰©å±•
- WebSocket åè®®æ”¯æŒ
- åŠ å¯†ä¼ è¾“æ”¯æŒ
- å‹ç¼©ä¼ è¾“æ”¯æŒ
- ç¼“å­˜æœºåˆ¶

### 2. æ€§èƒ½ä¼˜åŒ–
- é›¶æ‹·è´ä¼˜åŒ–
- å†…å­˜æ± ä¼˜åŒ–
- ç½‘ç»œæ ˆä¼˜åŒ–
- å¹¶å‘æ¨¡å‹ä¼˜åŒ–

### 3. è¿ç»´å¢å¼º
- ç›‘æ§æŒ‡æ ‡å®Œå–„
- å‘Šè­¦æœºåˆ¶
- è‡ªåŠ¨åŒ–éƒ¨ç½²
- æ•…éšœè‡ªæ„ˆ

### 4. ç”Ÿæ€é›†æˆ
- Prometheus æŒ‡æ ‡å¯¼å‡º
- Grafana ä»ªè¡¨æ¿
- Kubernetes éƒ¨ç½²æ”¯æŒ
- äº‘åŸç”Ÿé›†æˆ

## ğŸ“¦ å‘å¸ƒéƒ¨ç½²

### Windowsç‰ˆæœ¬
```bash
cargo build --release
# äº§ç‰©ï¼štarget/release/smart-forward.exe (~5.3MB)
```

### Dockerç‰ˆæœ¬
```bash
# åœ¨WSL2 Ubuntuä¸­æ„å»º
./build-docker.sh
./run-docker.sh
```

### å®Œæ•´éƒ¨ç½²æŒ‡å—
è¯¦ç»†çš„ç¼–è¯‘ã€éƒ¨ç½²å’Œè¿è¡ŒæŒ‡å—ï¼š
- **[FINAL-GUIDE.md](FINAL-GUIDE.md)** - å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ˆç¼–è¯‘ã€éƒ¨ç½²ã€è¿è¡Œï¼‰
- **[TECHNICAL-DOCS.md](TECHNICAL-DOCS.md)** - æŠ€æœ¯æ–‡æ¡£ï¼ˆæ¶æ„è®¾è®¡ã€å®ç°ç»†èŠ‚ï¼‰

å¯é€‰æ‹©å°† `smart-forward.exe` ä¸ `config.yaml` æ”¾å…¥åŒç›®å½•ç›´æ¥è¿è¡Œï¼Œæˆ–æŒ‰éœ€å°è£…ä¸ºæœåŠ¡/æ‰“åŒ…åˆ†å‘ã€‚

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š
- æŸ¥çœ‹ç°æœ‰æ–‡æ¡£
- æäº¤ Issue
- å‚ä¸è®¨è®º
- è´¡çŒ®ä»£ç 

---

*æœ€åæ›´æ–°æ—¶é—´: 2024å¹´*
