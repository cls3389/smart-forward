# 动态地址更新功能测试指南

## 测试目标
验证智能转发器能够自动检测后端地址变化并重新建立连接，解决群晖长时间连接后卡住的问题。

## 测试环境准备

### 1. 配置文件设置
确保 `config.yaml` 包含以下配置：
```yaml
dynamic_update:
  check_interval: 30        # 30秒检查一次
  connection_timeout: 300   # 5分钟超时
  auto_reconnect: true      # 启用自动重连
  health_check_interval: 60 # 健康检查间隔

rules:
  - name: "Drive"
    listen_port: 6690
    targets:
      - "192.168.5.3:6690"      # 本地地址
      - "hz.ipto.top:6690"      # 远程地址1
      - "drive.4.ipto.top"      # 远程地址2
    dynamic_update:
      enabled: true
      check_interval: 15        # 更频繁的检查
```

### 2. 启动转发器
```bash
# 编译
cargo build --release

# 运行
./target/release/smart-forward
```

## 测试步骤

### 步骤1：建立初始连接
1. 启动群晖设备连接到转发器端口6690
2. 观察日志输出，确认连接建立成功
3. 记录当前使用的目标地址

### 步骤2：模拟地址变化
1. 修改DNS记录或网络配置，使后端地址发生变化
2. 或者停止当前目标服务，触发故障转移
3. 观察转发器是否自动检测到地址变化

### 步骤3：验证自动重连
1. 检查日志中的地址更新信息
2. 确认旧连接被关闭
3. 验证新连接使用新的目标地址
4. 测试群晖连接是否正常工作

## 预期结果

### 日志输出示例
```
[INFO] 规则 Drive 检测到地址变化: 192.168.5.3:6690 -> hz.ipto.top:6690
[INFO] 统一转发器 Drive 更新目标地址: 192.168.5.3:6690 -> hz.ipto.top:6690
[INFO] 规则 Drive 关闭了 3 个连接以更新目标地址
[INFO] 转发器启动成功: Drive -> hz.ipto.top:6690
```

### 连接状态变化
- 旧连接被自动关闭
- 新连接使用新的目标地址
- 群晖设备无需手动重连
- 连接状态显示正常

## 故障排除

### 常见问题
1. **地址变化未检测到**
   - 检查 `check_interval` 配置
   - 确认 `dynamic_update.enabled` 为 true
   - 查看健康检查日志

2. **连接未自动重建**
   - 检查 `auto_reconnect` 配置
   - 确认目标地址可访问
   - 查看错误日志

3. **性能问题**
   - 调整检查间隔，避免过于频繁
   - 监控CPU和内存使用情况
   - 优化缓冲区大小

### 调试方法
1. 设置日志级别为 `debug`
2. 监控连接统计信息
3. 使用 `get_connection_details()` 查看连接详情
4. 检查网络连通性

## 性能指标

### 监控指标
- 地址检查频率：30秒/次
- 连接超时时间：5分钟
- 健康检查间隔：60秒
- 地址更新延迟：<1秒

### 优化建议
1. 根据网络环境调整检查间隔
2. 监控连接数量和流量
3. 定期检查日志和统计信息
4. 根据实际需求调整超时时间

## 测试完成标准

✅ 地址变化自动检测  
✅ 旧连接自动关闭  
✅ 新连接自动建立  
✅ 群晖连接正常工作  
✅ 日志记录完整准确  
✅ 性能指标符合预期  

## 注意事项

1. **测试环境**：在生产环境测试前，先在测试环境验证
2. **数据备份**：测试前备份重要数据
3. **监控告警**：设置适当的监控和告警机制
4. **回滚方案**：准备快速回滚到旧版本的方案
5. **性能影响**：监控动态更新对系统性能的影响
