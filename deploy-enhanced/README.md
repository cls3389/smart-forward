# 智能网络转发器

一个高性能的智能网络转发器，支持TCP和HTTP协议，具有动态地址更新、连接健康检查和自动故障转移功能。

## 主要特性

### 🔄 动态地址更新
- **自动检测后端地址变化**：每30秒检查一次后端地址状态
- **智能重连机制**：当检测到地址变化时，自动关闭旧连接并建立新连接
- **群晖连接优化**：专门解决群晖长时间连接后卡住的问题
- **可配置检查间隔**：支持全局和规则级别的配置

### 🏥 连接健康检查
- **实时连接监控**：跟踪每个连接的活动状态
- **自动超时清理**：5分钟无活动的连接自动关闭
- **连接统计信息**：详细的连接数量和流量统计

### 🚀 高性能转发
- **异步I/O处理**：基于tokio的高性能异步处理
- **智能缓冲区管理**：支持全局和规则级别的缓冲区配置
- **多协议支持**：TCP和HTTP协议支持

### 🔧 智能故障转移
- **多目标支持**：每个规则支持多个后端目标
- **自动选择最佳目标**：基于健康状态和延迟自动选择
- **无缝切换**：故障转移时不影响现有连接

## 解决群晖连接问题

### 问题描述
群晖设备长时间连接后，后端地址发生变化，但群晖没有重新连接，显示在线但实际上是卡住状态。

### 解决方案
1. **动态地址检测**：定期检查后端地址状态
2. **自动连接重建**：检测到地址变化时自动重建连接
3. **连接健康监控**：实时监控连接状态，及时发现问题
4. **智能超时处理**：自动清理僵尸连接

### 配置示例
```yaml
# 启用动态地址更新
dynamic_update:
  check_interval: 30        # 30秒检查一次
  connection_timeout: 300   # 5分钟超时
  auto_reconnect: true      # 启用自动重连
  health_check_interval: 60 # 健康检查间隔

rules:
  - name: "Drive"
    listen_port: 6690
    targets:
      - "192.168.5.3:6690"      # 本地地址
      - "hz.ipto.top:6690"      # 远程地址1
      - "drive.4.ipto.top"      # 远程地址2
    dynamic_update:
      enabled: true
      check_interval: 15        # 更频繁的检查
```

## 安装和运行

### 编译
```bash
cargo build --release
```

### 运行
```bash
# 前台运行
./target/release/smart-forward

# 后台运行
./target/release/smart-forward --daemon

# 指定配置文件
./target/release/smart-forward --config custom-config.yaml
```

### Windows运行
```cmd
# 前台运行
smart-forward.exe

# 后台运行
run-daemon.bat

# 停止后台服务
stop-daemon.bat
```

## 配置文件说明

### 基本配置
- `logging`: 日志配置
- `network`: 网络配置
- `buffer_size`: 全局缓冲区大小
- `dynamic_update`: 动态更新配置

### 规则配置
- `name`: 规则名称
- `listen_port`: 监听端口
- `targets`: 目标地址列表
- `buffer_size`: 规则专用缓冲区大小
- `dynamic_update`: 规则级动态更新配置

### 动态更新配置选项
- `enabled`: 是否启用动态更新
- `check_interval`: 检查间隔（秒）
- `connection_timeout`: 连接超时时间（秒）
- `auto_reconnect`: 是否启用自动重连
- `health_check_interval`: 健康检查间隔（秒）

## 监控和统计

### 连接统计
- 总连接数
- 活跃连接数
- 发送/接收字节数
- 连接运行时间

### 地址状态
- 当前目标地址
- 最后更新时间
- 地址变化历史

### 健康状态
- 目标地址健康状态
- 连接延迟信息
- 故障转移次数

## 动态地址更新功能测试

### 测试目标
验证智能转发器能够自动检测后端地址变化并重新建立连接，解决群晖长时间连接后卡住的问题。

### 测试步骤

#### 步骤1：建立初始连接
1. 启动群晖设备连接到转发器端口6690
2. 观察日志输出，确认连接建立成功
3. 记录当前使用的目标地址

#### 步骤2：模拟地址变化
1. 修改DNS记录或网络配置，使后端地址发生变化
2. 或者停止当前目标服务，触发故障转移
3. 观察转发器是否自动检测到地址变化

#### 步骤3：验证自动重连
1. 检查日志中的地址更新信息
2. 确认旧连接被关闭
3. 验证新连接使用新的目标地址
4. 测试群晖连接是否正常工作

### 预期结果

#### 日志输出示例
```
[INFO] 规则 Drive 检测到地址变化: 192.168.5.3:6690 -> hz.ipto.top:6690
[INFO] 统一转发器 Drive 更新目标地址: 192.168.5.3:6690 -> hz.ipto.top:6690
[INFO] 规则 Drive 关闭了 3 个连接以更新目标地址
[INFO] 转发器启动成功: Drive -> hz.ipto.top:6690
```

#### 连接状态变化
- 旧连接被自动关闭
- 新连接使用新的目标地址
- 群晖设备无需手动重连
- 连接状态显示正常

## 故障排除

### 常见问题
1. **连接卡住**：检查动态更新是否启用，检查后端地址状态
2. **性能问题**：调整缓冲区大小和检查间隔
3. **连接超时**：检查网络延迟和超时配置
4. **地址变化未检测到**：检查 `check_interval` 配置，确认 `dynamic_update.enabled` 为 true
5. **连接未自动重建**：检查 `auto_reconnect` 配置，确认目标地址可访问

### 日志分析
- `info`: 正常操作信息
- `warn`: 警告信息（如连接超时）
- `error`: 错误信息（如连接失败）

### 调试方法
1. 设置日志级别为 `debug`
2. 监控连接统计信息
3. 使用 `get_connection_details()` 查看连接详情
4. 检查网络连通性

## 性能优化建议

1. **检查间隔**：根据网络环境调整检查间隔
2. **缓冲区大小**：根据应用需求调整缓冲区
3. **连接超时**：根据网络延迟调整超时时间
4. **健康检查**：平衡检查频率和性能影响

### 监控指标
- 地址检查频率：30秒/次
- 连接超时时间：5分钟
- 健康检查间隔：60秒
- 地址更新延迟：<1秒

### 优化建议
1. 根据网络环境调整检查间隔
2. 监控连接数量和流量
3. 定期检查日志和统计信息
4. 根据实际需求调整超时时间

## 测试完成标准

✅ 地址变化自动检测  
✅ 旧连接自动关闭  
✅ 新连接自动建立  
✅ 群晖连接正常工作  
✅ 日志记录完整准确  
✅ 性能指标符合预期  

## 注意事项

1. **测试环境**：在生产环境测试前，先在测试环境验证
2. **数据备份**：测试前备份重要数据
3. **监控告警**：设置适当的监控和告警机制
4. **回滚方案**：准备快速回滚到旧版本的方案
5. **性能影响**：监控动态更新对系统性能的影响

## 许可证

MIT License
