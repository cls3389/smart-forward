# Smart Forward 项目规则文档

## 🎯 项目核心职责

### ✅ 核心功能
Smart-forward是一个**智能网络转发器**，专注于以下核心职责：

1. **🔄 更新后端地址**
   - DNS解析与监控
   - 健康检查与故障检测  
   - 地址切换与故障转移
   - 内核态/用户态转发规则更新

2. **🧹 清理僵尸连接**
   - TCP连接管理
   - UDP会话状态维护
   - 连接池清理

### ❌ 非核心功能 (不应包含)
- 自动重连逻辑 (应由OS/网络层处理)
- 复杂的网络恢复策略
- 应用层连接状态管理
- 业务逻辑处理

## 🏗️ 架构设计原则

### 1. 单一职责原则
- 每个模块专注单一功能
- 避免功能耦合
- 清晰的模块边界

### 2. 模块组织
```
src/
├── main.rs          # 程序入口与CLI处理
├── config.rs        # 配置管理 (Config, DnsConfig, DynamicUpdateConfig)
├── common.rs        # 核心逻辑 (健康检查, DNS解析, 地址切换)
├── utils.rs         # 工具函数 (DNS解析, 连接测试)
├── forwarder.rs     # 转发器实现 (TCP/UDP转发)
└── firewall.rs      # 防火墙规则管理 (nftables/iptables)
```

### 3. 配置设计
- **最小配置原则**: 只保留必要的配置选项
- **合理默认值**: 提供开箱即用的默认配置
- **向后兼容**: 新版本不破坏现有配置

## 📋 代码规范

### 1. Rust代码规范
- **MUST** 通过 `cargo fmt` 格式化
- **MUST** 通过 `cargo clippy` 检查
- **MUST** 通过 `cargo check` 编译检查
- **SHOULD** 通过所有测试

### 2. 提交规范
```bash
# 提交前检查流程
cargo fmt
cargo fmt -- --check
cargo clippy
cargo test
```

### 3. 版本发布流程
1. 代码质量检查通过
2. 更新版本号 (Cargo.toml + README.md)
3. 添加更新日志
4. 创建Git标签
5. 推送触发自动构建

## ⚙️ 配置文件设计

### 1. 核心配置结构
```yaml
logging:           # 日志配置
  level: "info"    # 生产环境使用info
  format: "text"   # 简洁的文本格式

network:           # 网络配置
  listen_addrs:    # 监听地址
    - "IP地址"     # 建议指定具体IP，避免0.0.0.0

dynamic_update:    # 动态更新配置 (核心)
  check_interval: 5       # 健康检查间隔 (秒)
  connection_timeout: 1   # 连接超时 (秒)

dns:               # DNS配置 (可选)
  servers:         # DNS服务器列表
    - "223.5.5.5:53"     # 推荐使用域名服务商DNS
  timeout: 1       # DNS查询超时
  attempts: 2      # 重试次数

rules:             # 转发规则 (核心)
  - name: "规则名"
    listen_port: 端口
    protocol: "tcp/udp"
    targets:       # 目标地址列表 (按优先级)
      - "内网地址"    # 优先级1
      - "外网备用"    # 优先级2
      - "域名解析"    # 优先级3
```

### 2. 配置原则
- **简洁优先**: 移除未实现或非必要的选项
- **语义清晰**: 配置名称要自解释
- **合理分组**: 相关配置归类组织

## 🔄 健康检查逻辑

### 1. 检查策略
- **UDP规则**: 仅DNS解析，跳过健康检查
- **TCP规则**: DNS解析 + TCP连接测试
- **检查间隔**: 5秒 (可配置)
- **故障阈值**: 失败1次即切换

### 2. 切换逻辑
```
健康检查 → 地址选择 → 规则更新 → 内核同步
    ↓         ↓         ↓         ↓
  5秒周期   优先级选择  nftables  DNAT/SNAT
```

## 🚀 部署与运维

### 1. 支持平台
- Linux (原生)
- OpenWrt (主要目标)
- Docker (容器化)
- Windows (开发/测试)

### 2. 日志管理
- **生产环境**: INFO级别
- **调试环境**: DEBUG级别
- **关键事件**: 地址切换、健康状态变化
- **避免**: 冗余的连接日志

### 3. 性能优化
- 内核态转发优先 (nftables/iptables)
- 用户态转发备用
- DNS解析优化 (1秒超时)
- 并发健康检查

## 📝 文档规范

### 1. 必需文档
- `README.md`: 完整的项目文档
- `config.yaml.example`: 配置示例
- `PROJECT_RULES.md`: 本规则文档
- 代码注释: 复杂逻辑说明

### 2. 文档原则
- **实用性**: 用户能快速上手
- **完整性**: 涵盖所有重要功能
- **准确性**: 与代码实现保持同步

## 🎯 设计决策记录

### v1.5.8 重要决策
1. **移除auto_reconnect配置**
   - 原因: 未实现且不符合职责边界
   - 影响: 配置更简洁，设计更清晰

2. **DNS配置可选化**
   - 原因: 提供灵活性同时保持兼容性
   - 默认: 使用阿里云DNS

3. **日志级别优化**
   - 生产: INFO级别减少噪音
   - 调试: DEBUG级别详细信息

## 📈 部署记录

### v1.5.8 生产部署 (2025-09-22)

**部署目标**: cudy OpenWrt设备 (ARMv8 双核, 479MB内存)

**部署过程**:
1. 下载 `smart-forward-linux-aarch64-musl.tar.gz` (2.2MB)
2. 备份v1.5.7为 `smart-forward.v1.5.7.backup`
3. 安装新版本到 `/usr/local/bin/smart-forward`
4. 配置验证通过，所有7个规则正常
5. 服务启动成功，进程ID: 2936

**验证结果**:
- ✅ 版本确认: v1.5.8
- ✅ 配置兼容: 无需修改配置文件
- ✅ 功能正常: 健康检查 `9个地址健康，3个地址异常`
- ✅ 性能优化: DNS超时1秒，配置简化生效
- ✅ 内核态转发: nftables规则正常工作

**关键改进生效**:
- 🧹 移除auto_reconnect配置，界面更简洁
- ⚡ DNS解析超时优化到1秒
- 🎯 专注核心转发功能
- 📚 项目规则文档建立

## 🔮 未来发展

### 短期目标
- 性能优化
- 错误处理完善
- 文档改进

### 长期规划
- 保持核心功能专注
- 避免功能膨胀
- 维护设计简洁性

---

## 📋 检查清单

发布新版本前确保：
- [ ] 代码质量检查通过
- [ ] 版本号已更新
- [ ] 更新日志已添加
- [ ] 配置文件已同步
- [ ] 文档已更新
- [ ] 核心功能测试通过

---

*本文档记录Smart Forward项目的核心设计理念和开发规范，确保项目始终专注于核心职责，保持简洁高效的设计。*
