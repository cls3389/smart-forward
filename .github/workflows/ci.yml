name: ğŸ” æŒç»­é›†æˆ

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'src/**'
      - 'Cargo.*'
      - 'Dockerfile'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ğŸš€ å¿«é€Ÿæ£€æŸ¥ - åªåšå¿…è¦çš„éªŒè¯
  check:
    name: ğŸ” ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      should-build-docker: ${{ steps.changes.outputs.docker }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: æ£€æµ‹å˜æ›´
        id: changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰Dockerç›¸å…³æ–‡ä»¶å˜æ›´
          if git diff --name-only HEAD~1 2>/dev/null | grep -E "(Dockerfile|docker-compose)" > /dev/null 2>&1; then
            echo "docker=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRæ—¶æ€»æ˜¯æ£€æŸ¥Dockeræ„å»º
            echo "docker=true" >> $GITHUB_OUTPUT
          else
            echo "docker=false" >> $GITHUB_OUTPUT
          fi

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-check-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-check-
            ${{ runner.os }}-cargo-

      - name: æ£€æŸ¥æ ¼å¼
        run: cargo fmt -- --check

      - name: Clippy æ£€æŸ¥
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: è¿è¡Œæµ‹è¯•
        run: cargo test --verbose

  # ğŸ³ Docker æ„å»º - åªåœ¨Dockerç›¸å…³æ–‡ä»¶å˜åŒ–æ—¶è¿è¡Œ
  docker-test:
    name: ğŸ³ Docker æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.should-build-docker == 'true' || github.event_name == 'pull_request'
    timeout-minutes: 8
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ„å»º Docker é•œåƒ (ä»…æµ‹è¯•)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: smart-forward:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ğŸ›¡ï¸ å®‰å…¨æ‰«æ - ç‹¬ç«‹è¿è¡Œ
  security:
    name: ğŸ›¡ï¸ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ç¼“å­˜ cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-${{ runner.os }}

      - name: å®‰è£… cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit
          fi

      - name: è¿è¡Œå®‰å…¨å®¡è®¡
        run: cargo audit
