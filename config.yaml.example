# ================================
# 智能网络转发器配置文件示例
# ================================
# 功能特性：
#   ✓ 支持TCP、UDP、HTTP协议转发
#   ✓ 动态地址解析与故障转移  
#   ✓ DNS缓存优化
#   ✓ 健康检查与自动切换
#   ✓ 同端口多协议支持 (TCP+UDP)
#   ✓ HTTP自动跳转HTTPS
#   ✓ 内核态转发支持 (nftables/iptables)
#   ✓ Firewall4优先级优化 (OpenWrt)
# ================================

# 日志配置
logging:
  level: "info"      # 日志级别: debug/info/warn/error
  format: "json"     # 日志格式: json/text (json格式便于后期处理)

# 网络配置
network:
  listen_addr: "0.0.0.0"    # 监听地址: 0.0.0.0表示绑定所有网卡

# 全局默认缓冲区大小 (字节) - 仅用户态转发有效
# 内核态转发时此设置无效，因为数据包直接在内核空间处理
# 建议值: HTTP(4KB) | 一般应用(8KB) | 大文件传输(32KB)
buffer_size: 8192

# ================================
# 转发规则配置
# ================================

rules:
  # --------------------------------
  # HTTPS 服务转发 (443端口)
  # --------------------------------  
  - name: "HTTPS"
    listen_port: 443
    protocol: "tcp"           # 单TCP协议 (HTTPS标准)
    buffer_size: 4096         # 4KB缓冲区，适合Web请求
    targets:                  # 按优先级排序，支持故障转移
      - "192.168.1.100:443"        # 优先级1: 主服务器
      - "backup.example.com:443"   # 优先级2: 备用服务器
      - "stun.example.com"         # 优先级3: 动态域名(TXT记录)
      
  # --------------------------------
  # RDP 服务转发 (99端口)
  # 支持TCP+UDP双协议，适配STUN穿透
  # --------------------------------
  - name: "RDP"
    listen_port: 99
    # 协议: 不指定时默认支持TCP+UDP双协议
    buffer_size: 16384        # 16KB缓冲区，适合RDP数据流
    targets:
      - "192.168.1.200:3389"       # 优先级1: 主RDP服务器  
      - "rdp-backup.example.com"   # 优先级2: 备用RDP服务器
      - "rdp.example.com"          # 优先级3: 动态域名解析
      
  # --------------------------------
  # 网盘服务转发 (6690端口) 
  # --------------------------------
  - name: "Drive"
    listen_port: 6690
    protocol: "tcp"           # 单TCP协议 (文件传输)
    buffer_size: 32768        # 32KB大缓冲区，优化文件传输
    targets:
      - "192.168.1.300:6690"       # 优先级1: 主网盘服务器
      - "drive-backup.example.com" # 优先级2: 备用网盘服务器  
      - "drive.example.com"        # 优先级3: 动态域名(TXT记录)

  # --------------------------------
  # 分离式RDP (999端口)
  # TCP+UDP分别配置，适合特殊场景
  # --------------------------------
  - name: "tRDP"            # RDP TCP协议
    listen_port: 999
    protocol: "tcp" 
    buffer_size: 16384    
    targets:
      - "rdp-tcp.example.com"      # TCP专用目标

  - name: "uRDP"            # RDP UDP协议  
    listen_port: 999
    protocol: "udp"
    buffer_size: 16384    
    targets:
      - "rdp-udp.example.com"      # UDP专用目标

  # --------------------------------
  # 内核态转发示例 (OpenWrt Firewall4)
  # --------------------------------
  - name: "Web-Kernel"
    listen_port: 8080
    protocol: "tcp"
    targets:
      - "192.168.1.100:80"       # 主Web服务器
      - "backup.example.com:80"   # 备用Web服务器

# ================================
# 配置说明：
# 1. 地址按配置顺序进行优先级排序
# 2. 域名支持A/AAAA记录和TXT记录解析
# 3. TCP+UDP同端口是合理配置，适合RDP等协议
# 4. 缓冲区大小根据应用类型调优
# 5. DNS缓存和健康检查自动进行
# ================================
#
# 转发模式说明：
# 1. 自动模式（推荐）：./smart-forward
#    - 自动尝试内核态转发，失败则回退到用户态
#    - 无需手动指定参数，智能选择最佳模式
# 
# 2. 强制内核态：./smart-forward --kernel-mode
#    - 强制使用内核态转发，失败则退出
#    - 适用于确定支持内核态转发的环境
#
# 3. 强制用户态：./smart-forward --user-mode  
#    - 强制使用用户态转发，禁用内核态尝试
#    - 适用于不支持内核态或需要调试的场景
#
# 内核态转发优势：
# - 更低延迟：数据包直接在内核处理，无用户态拷贝
# - 更高吞吐：避免用户态网络栈开销
# - 更少CPU：减少上下文切换和内存拷贝
# - 缓冲区无关：内核直接转发，buffer_size设置无效
# ================================
